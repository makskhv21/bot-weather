const { Telegraf } = require('telegraf');
const { session, Markup } = require('telegraf');
const axios = require('axios');
const moment = require('moment');

require('dotenv').config();

const BOT_TOKEN = process.env.BOT_TOKEN;
const OPENWEATHERMAP_API_KEY = process.env.OPENWEATHERMAP_API_KEY;

const bot = new Telegraf(BOT_TOKEN);

const users = {};
bot.use(session());


async function getCityByCoordinates(latitude, longitude) {
    const apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${OPENWEATHERMAP_API_KEY}`;
    try {
        const res = await axios.get(apiUrl);
        const city = res.data.name;
        return city;
    } catch (err) {
        throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ç–æ –∑–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—î—é.');
    }
}


// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ–≥–æ–¥–∏
async function getWeather(city) {
    const apiUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${OPENWEATHERMAP_API_KEY}&units=metric`;
    try {
        const res = await axios.get(apiUrl);
        return res.data;
    } catch (err) {
        throw new Error(`–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥—É –¥–ª—è –º—ñ—Å—Ç–∞ "${city}".`);
    }
}

function parseWeatherForecast(weatherData, days) {
    const forecasts = weatherData.list;
    const forecastsByDate = forecasts.reduce((acc, forecast) => {
        const date = moment.unix(forecast.dt).format('YYYY-MM-DD');  // –§–æ—Ä–º–∞—Ç—É—î–º–æ –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ "2024-11-10"
        if (!acc[date]) {
            acc[date] = [];
        }
        acc[date].push(forecast);
        return acc;
    }, {});

    const forecastEntries = Object.entries(forecastsByDate);
    const selectedForecasts = days === 1 ? [forecastEntries[0]] : forecastEntries.slice(0, 7);

    return selectedForecasts.map(([date, forecasts]) => {
        const formattedDate = moment(date).format('dddd, D MMMM YYYY');  // –§–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∞ –¥–∞—Ç–∞, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫, 10 –õ–∏—Å—Ç–æ–ø–∞–¥–∞ 2024"
        const formattedTemperatures = forecasts.map(forecast => {
            const timeOfDay = moment.unix(forecast.dt).format('HH:mm');
            const temp = formatTemperature(forecast.main.temp);
            const windSpeed = formatWindSpeed(forecast.wind.speed);
            const humidity = formatHumidity(forecast.main.humidity);

            return `‚è∞ *${timeOfDay}* - ${temp}, üå¨ ${windSpeed}, üíß ${humidity}%`;
        }).join('\n');

        return `*${formattedDate}*:\n${formattedTemperatures}`;
    }).join('\n\n');
}


function formatCityWeatherMessage(city, weatherData, forecastType) {
    const forecast = forecastType === 'today' ? parseWeatherForecast(weatherData, 1) : parseWeatherForecast(weatherData, 7);
    return `üåç *–ü–æ–≥–æ–¥–∞ –≤ –º—ñ—Å—Ç—ñ ${city}:*\n\n${forecast}\n\n‚òÄÔ∏è –ó–∞–ª–∏—à–∞–π—Ç–µ—Å—å –Ω–∞ –∑–≤'—è–∑–∫—É –∑ –Ω–∞—à–∏–º –±–æ—Ç–æ–º –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó!`;
}

function formatTemperature(temperature) {
    return isNaN(temperature) ? '*' : `${temperature.toFixed(1)}¬∞C`;
}

function formatWindSpeed(windSpeed) {
    return `${windSpeed.toFixed(1)} –º/—Å`;
}

function formatHumidity(humidity) {
    return `${humidity.toFixed(0)}`;
}

// –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
const KeyboardOptions = {
    TODAY: '–î—ñ–∑–Ω–∞—Ç–∏—Å—å –ø–æ–≥–æ–¥—É',
    ADD_CITY: '–î–æ–¥–∞—Ç–∏ –º—ñ—Å—Ç–æ',
    USE_LOCATION: '–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é',
};

function getMainKeyboard() {
    return Markup.keyboard([KeyboardOptions.TODAY, KeyboardOptions.ADD_CITY, KeyboardOptions.USE_LOCATION]).resize();
}

// –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –º—ñ—Å—Ç
function getCityKeyboard(userId) {
    const cities = users[userId]?.cities || [];
    const cityButtons = cities.map((city) => [
        Markup.button.callback(city, `city_${city}_today`),
        Markup.button.callback(`–ù–∞ —Ç–∏–∂–¥–µ–Ω—å`, `city_${city}_seven`),
        Markup.button.callback(`–í–∏–¥–∞–ª–∏—Ç–∏`, `remove_${city}`),
        Markup.button.callback(`–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—å –ø—Ä–æ–≥–Ω–æ–∑–æ–º`, `share_${city}`)
    ]);
    return Markup.inlineKeyboard(cityButtons);
}

function generateWeatherShareLink(city, weatherData, forecastType) {
    const forecast = forecastType === 'today' ? parseWeatherForecast(weatherData, 1) : parseWeatherForecast(weatherData, 7);
    const message = `üåç *–ü–æ–≥–æ–¥–∞ –≤ –º—ñ—Å—Ç—ñ ${city}:*\n\n${forecast}\n\n‚òÄÔ∏è –ó–∞–ª–∏—à–∞–π—Ç–µ—Å—å –Ω–∞ –∑–≤'—è–∑–∫—É –∑ –Ω–∞—à–∏–º –±–æ—Ç–æ–º –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó!`;
    const encodedMessage = encodeURIComponent(message);  // –ö–æ–¥—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const url = `https://t.me/share/url?url=${encodedMessage}`;  // –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –ø–æ–¥—ñ–ª—É
    return url;
}

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.command('start', (ctx) => {
    const username = ctx.message.from.first_name;
    ctx.reply(`–ü—Ä–∏–≤—ñ—Ç, ${username}! –Ø –ø–æ–≥–æ–¥–Ω–∏–π –±–æ—Ç. –ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?`, getMainKeyboard());
});

// –ö–æ–º–∞–Ω–¥–∞ /addcity
bot.command('addcity', (ctx) => {
    ctx.reply('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞:');
    ctx.session.stage = 'add_city';
});

bot.command('setnotification', (ctx) => {
    ctx.reply('–í–≤–µ–¥—ñ—Ç—å —á–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ HH:mm (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 08:30):');
    ctx.session.stage = 'set_notification_time';
});
// –ö–æ–º–∞–Ω–¥–∞ /about
bot.command('about', (ctx) => {
    const aboutMessage = `
    ü§ñ **–ü—Ä–æ —Ü—å–æ–≥–æ –±–æ—Ç–∞:**
    –Ø –ø–æ–≥–æ–¥–Ω–∏–π –±–æ—Ç, —è–∫–∏–π –Ω–∞–¥–∞—î –∞–∫—Ç—É–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–æ–≥–æ–¥—É –≤ —Ä—ñ–∑–Ω–∏—Ö –º—ñ—Å—Ç–∞—Ö.
    –Ø –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ –¥—ñ–∑–Ω–∞—Ç–∏—Å—å –ø–æ–≥–æ–¥—É –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ –∞–±–æ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—ñ–ª—å–∫–∞ –¥–Ω—ñ–≤.
    üí¨ –í–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞–≤–∞—Ç–∏ –º—ñ—Å—Ç–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–≤–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–æ–≥–æ–¥–∏ —Ç–∞ –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ —â–æ–¥–µ–Ω–Ω—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.
    `;
    ctx.reply(aboutMessage);
});
// –ö–æ–º–∞–Ω–¥–∞ /help
bot.command('help', (ctx) => {
    const helpMessage = `
    üìò **–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:**
    –û—Å—å –∫—ñ–ª—å–∫–∞ –∫–æ–º–∞–Ω–¥, —è–∫—ñ –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:
    - /start ‚Äî –ü–æ—á–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –∑ –±–æ—Ç–æ–º
    - /about ‚Äî –î—ñ–∑–Ω–∞—Ç–∏—Å—å –±—ñ–ª—å—à–µ –ø—Ä–æ –±–æ—Ç–∞
    - /help ‚Äî –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ–ø–æ–º–æ–≥—É —â–æ–¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –±–æ—Ç–∞
    - /addcity ‚Äî –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –º—ñ—Å—Ç–æ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É –ø–æ–≥–æ–¥–∏
    - /setnotification ‚Äî –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —â–æ–¥–µ–Ω–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –º—ñ—Å—Ç–∞
    - /remove_notification ‚Äî –í–∏–¥–∞–ª–∏—Ç–∏ —á–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
    `;
    ctx.reply(helpMessage);
});
const NotificationKeyboardOptions = {
    SET_NOTIFICATION: '–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ —â–æ–¥–µ–Ω–Ω–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è',
    REMOVE_NOTIFICATION: '–í–∏–¥–∞–ª–∏—Ç–∏ —á–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è',
    BACK_TO_MAIN_MENU: '–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é',
};

function getNotificationKeyboard() {
    return Markup.keyboard([
        [
            NotificationKeyboardOptions.SET_NOTIFICATION,
            NotificationKeyboardOptions.REMOVE_NOTIFICATION
        ],
        [
            NotificationKeyboardOptions.BACK_TO_MAIN_MENU 
        ]
    ]).resize();
}

bot.hears(NotificationKeyboardOptions.BACK_TO_MAIN_MENU, (ctx) => {
    ctx.reply('–í–∏ –ø–æ–≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é.', getMainKeyboard());  
});

function getCityForNotificationKeyboard(userId) {
    const cities = users[userId]?.cities || [];
    const cityButtons = cities.map((city) => [
        Markup.button.callback(city, `set_notification_${city}`)
    ]);
    return Markup.inlineKeyboard(cityButtons);
}

// –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –º—ñ—Å—Ç–∞ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
bot.hears(NotificationKeyboardOptions.SET_NOTIFICATION, (ctx) => {
    const userId = ctx.message.from.id;
    if (users[userId]?.cities?.length > 0) {
        ctx.reply('–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:', getCityForNotificationKeyboard(userId));
    } else {
        ctx.reply('‚ùå –£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –º—ñ—Å—Ç. –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –º—ñ—Å—Ç–æ.');
    }
});

// –û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –º—ñ—Å—Ç–∞
bot.on('message', async (ctx) => {
    const userId = ctx.message.from.id;

    if (!ctx.session) {
        ctx.session = {};
    }

    if (ctx.session.stage === 'add_city') {
        const city = ctx.message.text.trim();
        try {
            await getWeather(city);
            if (!users[userId]) users[userId] = { cities: [] };
            users[userId].cities.push(city);
            ctx.reply(`–ú—ñ—Å—Ç–æ "${city}" –¥–æ–¥–∞–Ω–æ!`, getMainKeyboard());
            ctx.session.stage = undefined;
        } catch (error) {
            ctx.reply(`–ú—ñ—Å—Ç–æ "${city}" –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.`);
        }
    }

    if (ctx.message.text === KeyboardOptions.TODAY && users[userId]?.cities.length) {
        ctx.reply('–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ:', getCityKeyboard(userId));
    }

    if (ctx.message.text === KeyboardOptions.ADD_CITY) {
        ctx.reply('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞:');
        ctx.session.stage = 'add_city';
    }

    if (ctx.message.text === KeyboardOptions.USE_LOCATION) {
        ctx.reply('–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Å–≤–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é, —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø–æ–≥–æ–¥—É –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ.');
    }

    // –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–¥—ñ—Å–ª–∞–≤ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é
    if (ctx.message.location) {
        const { latitude, longitude } = ctx.message.location;
        try {
            const city = await getCityByCoordinates(latitude, longitude);
            const weatherData = await getWeather(city);
            const weatherMessage = formatCityWeatherMessage(city, weatherData, 'today');
            ctx.reply(weatherMessage, getMainKeyboard());
        } catch (error) {
            ctx.reply('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–∑–Ω–∞—á–∏—Ç–∏ –º—ñ—Å—Ç–æ –∑–∞ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—î—é.');
        }
    }

    if (ctx.session.stage === 'set_notification_time') {
        const time = ctx.message.text.trim();

        const timeRegex = /^([01]?[0-9]|2[0-3]):([0-5][0-9])$/;
        if (timeRegex.test(time)) {
            const city = ctx.session.selectedCityForNotification;
            if (!users[userId]) users[userId] = {};

            if (!users[userId].notifications) {
                users[userId].notifications = {};
            }
            users[userId].notifications[city] = time;

            ctx.reply(`–ß–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –º—ñ—Å—Ç–∞ "${city}" –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ ${time}.`, getNotificationKeyboard());
            ctx.session.stage = undefined;
        } else {
            ctx.reply('‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —á–∞—Å—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ–æ—Ä–º–∞—Ç HH:mm (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 08:30).');
        }
    }

    if (ctx.message.text === NotificationKeyboardOptions.REMOVE_NOTIFICATION) {
        if (users[userId]?.notificationTime) {
            delete users[userId].notificationTime;
            ctx.reply('–ß–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.', getNotificationKeyboard());
        } else {
            ctx.reply('–ù–µ–º–∞—î –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ–≥–æ —á–∞—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è.', getNotificationKeyboard());
        }
    }
});

bot.hears(NotificationKeyboardOptions.REMOVE_NOTIFICATION, (ctx) => {
    const userId = ctx.message.from.id;
    const cities = users[userId]?.cities || [];

    if (cities.length > 0) {
        ctx.reply('–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –¥–ª—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —á–∞—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è:', getCityForNotificationKeyboard(userId));
    } else {
        ctx.reply('‚ùå –£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –º—ñ—Å—Ç. –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –º—ñ—Å—Ç–æ.');
    }
});

bot.action(/^remove_notification_(.+)$/, (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    if (users[userId]?.notifications && users[userId].notifications[city]) {
        delete users[userId].notifications[city];
        ctx.reply(`–ß–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è –º—ñ—Å—Ç–∞ "${city}" –≤–∏–¥–∞–ª–µ–Ω–æ.`, getNotificationKeyboard());
    } else {
        ctx.reply('‚ùå –ù–µ–º–∞—î –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ–≥–æ —á–∞—Å—É —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –¥–ª—è —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞.');
    }
});

function checkNotifications() {
    setInterval(() => {
        const now = moment().format('HH:mm');  
        Object.keys(users).forEach(userId => {
            const notifications = users[userId]?.notifications || {};
            Object.keys(notifications).forEach(city => {
                if (notifications[city] === now) {

                    getWeather(city).then(weatherData => {
                        const weatherMessage = formatCityWeatherMessage(city, weatherData, 'today');
                        bot.telegram.sendMessage(userId, weatherMessage);
                    });
                }
            });
        });
    }, 60000);  
}

checkNotifications();

bot.action(/^set_notification_(.+)$/, (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    ctx.session.selectedCityForNotification = city;
    ctx.reply(`–í–∏–±—Ä–∞–Ω–æ –º—ñ—Å—Ç–æ: ${city}. –¢–µ–ø–µ—Ä –≤–≤–µ–¥—ñ—Ç—å —á–∞—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ HH:mm (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 08:30):`);
    ctx.session.stage = 'set_notification_time';
});


bot.action(/^city_(.+)_today$/, async (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    try {
        const weatherData = await getWeather(city);
        const weatherMessage = formatCityWeatherMessage(city, weatherData, 'today');
        ctx.reply(weatherMessage, getCityKeyboard(userId));
    } catch (error) {
        ctx.reply('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞.');
    }
});

bot.action(/^city_(.+)_seven$/, async (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    try {
        const weatherData = await getWeather(city);
        const weatherMessage = formatCityWeatherMessage(city, weatherData, 'seven');
        ctx.reply(weatherMessage, getCityKeyboard(userId));
    } catch (error) {
        ctx.reply('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞.');
    }
});

bot.action(/^remove_(.+)$/, (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    if (users[userId]) {
        users[userId].cities = users[userId].cities.filter((item) => item !== city);
        ctx.reply(`üóë –ú—ñ—Å—Ç–æ "${city}" –≤–∏–¥–∞–ª–µ–Ω–æ –∑—ñ —Å–ø–∏—Å–∫—É.`, getCityKeyboard(userId));
    } else {
        ctx.reply('‚ùå –©–æ—Å—å –ø—ñ—à–ª–æ –Ω–µ —Ç–∞–∫. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
    }
});

bot.action(/^share_(.+)$/, async (ctx) => {
    const city = ctx.match[1];
    const userId = ctx.from.id;

    try {
        const weatherData = await getWeather(city);
        const weatherMessage = formatCityWeatherMessage(city, weatherData, 'today');  // –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ
        const shareLink = generateWeatherShareLink(city, weatherData, 'today');  // –ì–µ–Ω–µ—Ä—É—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –ø–æ–¥—ñ–ª—É
        ctx.reply(`–û—Å—å –≤–∞—à –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è –º—ñ—Å—Ç–∞ ${city}:\n${weatherMessage}\n\n–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –Ω–∏–º –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º: ${shareLink}`, getCityKeyboard(userId));
    } catch (error) {
        ctx.reply('‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ–≥–æ–¥–Ω—ñ –¥–∞–Ω—ñ –¥–ª—è —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞.');
    }
});

bot.launch()
    .then(() => console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–∏–π'))
    .catch((err) => console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É:', err));